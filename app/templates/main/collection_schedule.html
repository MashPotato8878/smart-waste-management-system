{% extends "base.html" %}

{% block title %}Collection Schedule{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Collection Schedule</h2>

    <!-- Map showing collection points -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" id="locationSearch" class="form-control" placeholder="Search location...">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchLocation()">
                            <i class="fas fa-search"></i> Search
                        </button>
                        <button class="btn btn-outline-primary" type="button" onclick="getCurrentLocation()">
                            <i class="fas fa-location-arrow"></i> My Location
                        </button>
                    </div>
                </div>
            </div>
            <div id="map" class="map-container"></div>
        </div>
    </div>

    <!-- Collection Schedule List -->
    {% if schedule %}
    <div class="row">
        {% for collection in schedule %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Collection at {{ collection.bin.location }}</h5>
                    <p class="card-text">
                        <strong>Date:</strong> {{ collection.collection_time.strftime('%Y-%m-%d') }}<br>
                        <strong>Time:</strong> {{ collection.collection_time.strftime('%H:%M') }}<br>
                        <strong>Status:</strong> 
                        {% if collection.completed %}
                        <span class="badge bg-success">Completed</span>
                        {% elif collection.is_past_due %}
                        <span class="badge bg-danger">Past Due</span>
                        {% else %}
                        <span class="badge bg-warning">Pending</span>
                        {% endif %}
                    </p>
                    {% if collection.notes %}
                    <p class="card-text"><strong>Notes:</strong> {{ collection.notes }}</p>
                    {% endif %}
                    {% if current_user.is_admin and not collection.completed %}
                    <div class="mt-3">
                        <button class="btn btn-success btn-sm" onclick="markAsCompleted({{ collection.id }})">
                            Mark as Completed
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        No collection schedules found for your area.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
let map;
let markers = [];
let userMarker;
let searchControl;

function initMap() {
    // Initialize map
    map = L.map('map').setView([0, 0], 2); // Start with a world view

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Add search control
    searchControl = L.Control.geocoder({
        defaultMarkGeocode: false,
        placeholder: 'Search location...',
        errorMessage: 'No results found.',
        showResultIcons: true,
        suggestMinLength: 3,
        suggestTimeout: 250,
        queryMinLength: 1,
        suggestMaxLength: 5
    }).addTo(map);

    // Handle search results
    searchControl.on('markgeocode', function(e) {
        const latlng = e.geocode.center;
        map.setView(latlng, 15);
        if (userMarker) {
            map.removeLayer(userMarker);
        }
        userMarker = L.marker(latlng, {
            icon: L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="
                    background-color: blue;
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    border: 2px solid white;
                    box-shadow: 0 0 4px rgba(0,0,0,0.5);
                "></div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            })
        }).addTo(map);
    });

    // Add markers for each collection point
    {% for collection in schedule %}
    addMarker({
        position: [{{ collection.bin.latitude }}, {{ collection.bin.longitude }}],
        title: "Collection at {{ collection.bin.location }}",
        time: "{{ collection.collection_time.strftime('%Y-%m-%d %H:%M') }}",
        status: "{{ 'Completed' if collection.completed else 'Past Due' if collection.is_past_due else 'Pending' }}",
        id: {{ collection.id }}
    });
    {% endfor %}

    // Try to get user's location
    getCurrentLocation();
}

function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const latlng = [position.coords.latitude, position.coords.longitude];
                map.setView(latlng, 15);
                
                // Add or update user marker
                if (userMarker) {
                    map.removeLayer(userMarker);
                }
                userMarker = L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="
                            background-color: blue;
                            width: 12px;
                            height: 12px;
                            border-radius: 50%;
                            border: 2px solid white;
                            box-shadow: 0 0 4px rgba(0,0,0,0.5);
                        "></div>`,
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    })
                }).addTo(map);
            },
            (error) => {
                console.error('Error getting location:', error);
                alert('Unable to get your location. Please enable location services or search for a location.');
            }
        );
    } else {
        alert('Geolocation is not supported by your browser');
    }
}

function searchLocation() {
    const searchInput = document.getElementById('locationSearch').value;
    if (searchInput) {
        searchControl.geocode(searchInput);
    }
}

function addMarker(props) {
    // Create custom icon based on status
    const iconColor = props.status === 'Completed' ? 'green' : 
                     props.status === 'Pending' ? 'yellow' : 'red';
    
    const icon = L.divIcon({
        className: 'custom-div-icon',
        html: `<div style="
            background-color: ${iconColor};
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 4px rgba(0,0,0,0.5);
        "></div>`,
        iconSize: [12, 12],
        iconAnchor: [6, 6]
    });

    const marker = L.marker(props.position, { icon: icon })
        .addTo(map)
        .bindPopup(`
            <div>
                <h6>${props.title}</h6>
                <p>Time: ${props.time}</p>
                <p>Status: ${props.status}</p>
            </div>
        `);

    markers.push(marker);
}

function markAsCompleted(collectionId) {
    if (confirm('Are you sure you want to mark this collection as completed?')) {
        fetch(`/api/collections/${collectionId}/complete`, {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error marking collection as completed: ' + data.message);
            }
        });
    }
}

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %} 